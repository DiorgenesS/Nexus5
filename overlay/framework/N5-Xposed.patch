From a3fc031dfb9ac99cc271d88f04cb75d640cf7184 Mon Sep 17 00:00:00 2001
From: Diorgenes <dyogenes_gd@hotmail.com>
Date: Fri, 27 Jan 2017 00:00:15 -0300
Subject: [PATCH] Support xposed MIUI edition install

---
 .../android/app/ApplicationPackageManager.smali    |   4 +
 framework/smali/android/app/ContextImpl.smali      |   6 ++
 framework/smali/android/app/LoadedApk.smali        |   6 ++
 .../smali/android/content/res/AssetManager.smali   |   4 +
 .../smali/android/content/res/Configuration.smali  | 101 +++++++++++++++++++--
 .../android/content/res/Resources$Theme.smali      |  31 ++++++-
 .../smali/android/content/res/Resources.smali      |  44 +++++++--
 .../smali/android/content/res/TypedArray.smali     |   4 +-
 framework/smali/android/graphics/Bitmap.smali      |   2 +-
 9 files changed, 182 insertions(+), 20 deletions(-)

--- a/framework/smali/android/app/ApplicationPackageManager.smali
+++ b/framework/smali/android/app/ApplicationPackageManager.smali
@@ -4309,6 +4309,10 @@
     move-result-object v8

     .local v8, "r":Landroid/content/res/Resources;
+    iget-object v0, p1, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
+
+    invoke-static {v8, v0}, Landroid/miui/ResourcesManager;->initMiuiResource(Landroid/content/res/Resources;Ljava/lang/String;)V
+
     if-eqz v8, :cond_4

     return-object v8

--- a/framework/smali/android/app/ContextImpl.smali
+++ b/framework/smali/android/app/ContextImpl.smali
@@ -395,6 +395,12 @@

     move-result-object v10

+    iget-object v1, p0, Landroid/app/ContextImpl;->mPackageInfo:Landroid/app/LoadedApk;
+
+    iget-object v1, v1, Landroid/app/LoadedApk;->mPackageName:Ljava/lang/String;
+
+    invoke-static {v10, v1}, Landroid/miui/ResourcesManager;->initMiuiResource(Landroid/content/res/Resources;Ljava/lang/String;)V
+
     :cond_4
     iput-object v10, p0, Landroid/app/ContextImpl;->mResources:Landroid/content/res/Resources;


--- a/framework/smali/android/app/LoadedApk.smali
+++ b/framework/smali/android/app/LoadedApk.smali
@@ -2442,6 +2442,12 @@

     iput-object v0, p0, Landroid/app/LoadedApk;->mResources:Landroid/content/res/Resources;

+    iget-object v0, p0, Landroid/app/LoadedApk;->mResources:Landroid/content/res/Resources;
+
+    iget-object v1, p0, Landroid/app/LoadedApk;->mPackageName:Ljava/lang/String;
+
+    invoke-static {v0, v1}, Landroid/miui/ResourcesManager;->initMiuiResource(Landroid/content/res/Resources;Ljava/lang/String;)V
+
     :cond_0
     iget-object v0, p0, Landroid/app/LoadedApk;->mResources:Landroid/content/res/Resources;


--- a/framework/smali/android/content/res/AssetManager.smali
+++ b/framework/smali/android/content/res/AssetManager.smali
@@ -244,6 +244,8 @@
     invoke-direct {p0, v0}, Landroid/content/res/AssetManager;->init(Z)V

     invoke-static {}, Landroid/content/res/AssetManager;->ensureSystemAssets()V
+
+    invoke-static {p0}, Landroid/miui/ResourcesManager;->addSystemAssets(Landroid/content/res/AssetManager;)V
     :try_end_0
     .catchall {:try_start_0 .. :try_end_0} :catchall_0

@@ -296,6 +298,8 @@

     invoke-direct {p0, v1}, Landroid/content/res/AssetManager;->init(Z)V

+    invoke-static {p0}, Landroid/miui/ResourcesManager;->addSystemAssets(Landroid/content/res/AssetManager;)V
+
     return-void
 .end method


--- a/framework/smali/android/content/res/Configuration.smali
+++ b/framework/smali/android/content/res/Configuration.smali
@@ -324,35 +324,53 @@
 .end method

 .method public constructor <init>()V
-    .locals 0
+    .locals 1

     .prologue
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V

+    new-instance v0, Landroid/content/res/MiuiConfiguration;
+
+    invoke-direct {v0}, Landroid/content/res/MiuiConfiguration;-><init>()V
+
+    iput-object v0, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
     invoke-virtual {p0}, Landroid/content/res/Configuration;->setToDefaults()V

     return-void
 .end method

 .method public constructor <init>(Landroid/content/res/Configuration;)V
-    .locals 0
+    .locals 1
     .param p1, "o"    # Landroid/content/res/Configuration;

     .prologue
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V

+    new-instance v0, Landroid/content/res/MiuiConfiguration;
+
+    invoke-direct {v0}, Landroid/content/res/MiuiConfiguration;-><init>()V
+
+    iput-object v0, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
     invoke-virtual {p0, p1}, Landroid/content/res/Configuration;->setTo(Landroid/content/res/Configuration;)V

     return-void
 .end method

 .method private constructor <init>(Landroid/os/Parcel;)V
-    .locals 0
+    .locals 1
     .param p1, "source"    # Landroid/os/Parcel;

     .prologue
     invoke-direct {p0}, Ljava/lang/Object;-><init>()V

+    new-instance v0, Landroid/content/res/MiuiConfiguration;
+
+    invoke-direct {v0}, Landroid/content/res/MiuiConfiguration;-><init>()V
+
+    iput-object v0, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
     invoke-virtual {p0, p1}, Landroid/content/res/Configuration;->readFromParcel(Landroid/os/Parcel;)V

     return-void
@@ -865,11 +883,18 @@

     and-int/2addr v1, p0

-    if-eqz v1, :cond_0
+    if-nez v1, :cond_0

-    const/4 v0, 0x1
+    invoke-static {p0}, Landroid/content/res/MiuiConfiguration;->needNewResources(I)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_1

     :cond_0
+    const/4 v0, 0x1
+
+    :cond_1
     return v0
 .end method

@@ -2372,6 +2397,14 @@

     sub-int v2, v3, v4

+    iget-object v3, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    iget-object v4, p1, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    invoke-virtual {v3, v4}, Landroid/content/res/MiuiConfiguration;->compareTo(Landroid/content/res/MiuiConfiguration;)I
+
+    move-result v2
+
     return v2
 .end method

@@ -2714,6 +2747,16 @@

     :cond_11
+    iget-object v2, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    iget-object v3, p1, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    invoke-virtual {v2, v3}, Landroid/content/res/MiuiConfiguration;->diff(Landroid/content/res/MiuiConfiguration;)I
+
+    move-result v2
+
+    or-int/2addr v0, v2
+
     return v0

     .end local v1    # "deltaScreenLayoutDir":I
     :cond_12
@@ -2981,6 +3024,16 @@

     add-int v0, v1, v2

+    mul-int/lit8 v1, v0, 0x1f
+
+    iget-object v2, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    invoke-virtual {v2}, Landroid/content/res/MiuiConfiguration;->hashCode()I
+
+    move-result v2
+
+    add-int v0, v1, v2
+
     return v0

     :cond_0
@@ -3278,6 +3331,10 @@

     iput v0, p0, Landroid/content/res/Configuration;->seq:I

+    iget-object v0, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    invoke-virtual {v0, p1}, Landroid/content/res/MiuiConfiguration;->readFromParcel(Landroid/os/Parcel;)V
+
     return-void

     :cond_1
@@ -3326,7 +3383,7 @@
 .end method

 .method public setTo(Landroid/content/res/Configuration;)V
-    .locals 1
+    .locals 2
     .param p1, "o"    # Landroid/content/res/Configuration;

     .prologue
@@ -3444,6 +3501,12 @@

     iput v0, p0, Landroid/content/res/Configuration;->seq:I

+    iget-object v0, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    iget-object v1, p1, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    invoke-virtual {v0, v1}, Landroid/content/res/MiuiConfiguration;->setTo(Landroid/content/res/MiuiConfiguration;)V
+
     return-void
 .end method

@@ -3503,6 +3566,10 @@

     iput v1, p0, Landroid/content/res/Configuration;->seq:I

+    iget-object v0, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    invoke-virtual {v0}, Landroid/content/res/MiuiConfiguration;->setToDefaults()V
+
     return-void
 .end method

@@ -3835,6 +3902,14 @@
     invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;

     :cond_0
+    iget-object v2, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    invoke-virtual {v2}, Landroid/content/res/MiuiConfiguration;->toString()Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
     const/16 v2, 0x7d

     invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(C)Ljava/lang/StringBuilder;
@@ -4768,6 +4843,16 @@
     iput v2, p0, Landroid/content/res/Configuration;->seq:I

     :cond_18
+    iget-object v2, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    iget-object v3, p1, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    invoke-virtual {v2, v3}, Landroid/content/res/MiuiConfiguration;->updateFrom(Landroid/content/res/MiuiConfiguration;)I
+
+    move-result v2
+
+    or-int/2addr v0, v2
+
     return v0

     .end local v1    # "deltaScreenLayoutDir":I
@@ -4965,6 +5050,10 @@

     invoke-virtual {p1, v0}, Landroid/os/Parcel;->writeInt(I)V

+    iget-object v0, p0, Landroid/content/res/Configuration;->extraConfig:Landroid/content/res/MiuiConfiguration;
+
+    invoke-virtual {v0, p1, p2}, Landroid/content/res/MiuiConfiguration;->writeToParcel(Landroid/os/Parcel;I)V
+
     return-void

     :cond_0

--- a/framework/smali/android/content/res/Resources$Theme.smali
+++ b/framework/smali/android/content/res/Resources$Theme.smali
@@ -445,7 +445,13 @@

     invoke-static/range {v0 .. v8}, Landroid/content/res/AssetManager;->applyStyle(JIIJ[I[I[I)Z

-    return-object v9
+    iget-object v0, p0, Landroid/content/res/Resources$Theme;->this$0:Landroid/content/res/Resources;
+
+    invoke-virtual {v0, v9}, Landroid/content/res/Resources;->loadOverlayTypedArray(Landroid/content/res/TypedArray;)Landroid/content/res/TypedArray;
+
+    move-result-object v0
+
+    return-object v0
 .end method

 .method public obtainStyledAttributes(Landroid/util/AttributeSet;[III)Landroid/content/res/TypedArray;
@@ -503,7 +509,13 @@

     iput-object v11, v9, Landroid/content/res/TypedArray;->mXml:Landroid/content/res/XmlBlock$Parser;

-    return-object v9
+    iget-object v0, p0, Landroid/content/res/Resources$Theme;->this$0:Landroid/content/res/Resources;
+
+    invoke-virtual {v0, v9}, Landroid/content/res/Resources;->loadOverlayTypedArray(Landroid/content/res/TypedArray;)Landroid/content/res/TypedArray;
+
+    move-result-object v0
+
+    return-object v0

     :cond_0
     const-wide/16 v4, 0x0
@@ -550,7 +562,13 @@

     invoke-static/range {v0 .. v8}, Landroid/content/res/AssetManager;->applyStyle(JIIJ[I[I[I)Z

-    return-object v9
+    iget-object v0, p0, Landroid/content/res/Resources$Theme;->this$0:Landroid/content/res/Resources;
+
+    invoke-virtual {v0, v9}, Landroid/content/res/Resources;->loadOverlayTypedArray(Landroid/content/res/TypedArray;)Landroid/content/res/TypedArray;
+
+    move-result-object v0
+
+    return-object v0
 .end method

 .method public rebase()V
@@ -630,6 +648,13 @@
     move-result v0

     .local v0, "got":Z
+    if-eqz v0, :cond_0
+
+    iget-object v1, p0, Landroid/content/res/Resources$Theme;->this$0:Landroid/content/res/Resources;
+
+    invoke-virtual {v1, p2, p1}, Landroid/content/res/Resources;->loadOverlayValue(Landroid/util/TypedValue;I)V
+
+    :cond_0
     return v0
 .end method

--- a/framework/smali/android/content/res/Resources.smali
+++ b/framework/smali/android/content/res/Resources.smali
@@ -181,6 +181,12 @@

     sput-object v0, Landroid/content/res/Resources;->sPreloadedColorDrawables:Landroid/util/LongSparseArray;

+    new-instance v0, Landroid/util/LongSparseArray;
+
+    invoke-direct {v0}, Landroid/util/LongSparseArray;-><init>()V
+
+    sput-object v0, Landroid/content/res/Resources;->sCachedDrawables:Landroid/util/LongSparseArray;
+
     new-instance v0, Landroid/util/LongSparseArray;

     invoke-direct {v0}, Landroid/util/LongSparseArray;-><init>()V
@@ -797,9 +803,18 @@

     :try_start_0
     invoke-virtual/range {v1 .. v6}, Landroid/content/res/DrawableCache;->put(JLandroid/content/res/Resources$Theme;Ljava/lang/Object;Z)V
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0

+    iget-boolean v1, p0, Landroid/content/res/Resources;->mCaching:Z
+
+    if-eqz v1, :cond_5
+
+    if-nez p2, :cond_5
+
+    sget-object v1, Landroid/content/res/Resources;->sCachedDrawables:Landroid/util/LongSparseArray;
+
+    invoke-virtual {v1, p6, p7, v5}, Landroid/util/LongSparseArray;->put(JLjava/lang/Object;)V
+
+    :cond_5
     monitor-exit v7

     goto :goto_0
@@ -809,6 +824,8 @@
     move-exception v1

     monitor-exit v7
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0

     throw v1
 .end method
@@ -962,8 +979,10 @@

     .restart local v0    # "ret":Landroid/content/res/Resources;
     sput-object v0, Landroid/content/res/Resources;->mSystem:Landroid/content/res/Resources;
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    const/4 v1, 0x0
+
+    invoke-static {v0, v1}, Landroid/miui/ResourcesManager;->initMiuiResource(Landroid/content/res/Resources;Ljava/lang/String;)V

     :cond_0
     monitor-exit v2
@@ -976,6 +995,8 @@
     move-exception v1

     monitor-exit v2
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0

     throw v1
 .end method
@@ -1294,7 +1315,7 @@
     move-result-object v5

     .local v5, "rp":Landroid/content/res/XmlResourceParser;
-    invoke-static {p0, v5, p3}, Landroid/graphics/drawable/Drawable;->createFromXml(Landroid/content/res/Resources;Lorg/xmlpull/v1/XmlPullParser;Landroid/content/res/Resources$Theme;)Landroid/graphics/drawable/Drawable;
+    invoke-virtual {p0, p1, v5, p2, p3}, Landroid/content/res/Resources;->createFromXml(Landroid/util/TypedValue;Landroid/content/res/XmlResourceParser;ILandroid/content/res/Resources$Theme;)Landroid/graphics/drawable/Drawable;

     move-result-object v0

@@ -1330,9 +1351,8 @@
     move-result-object v3

     .local v3, "is":Ljava/io/InputStream;
-    const/4 v6, 0x0

-    invoke-static {p0, p1, v3, v2, v6}, Landroid/graphics/drawable/Drawable;->createFromResourceStream(Landroid/content/res/Resources;Landroid/util/TypedValue;Ljava/io/InputStream;Ljava/lang/String;Landroid/graphics/BitmapFactory$Options;)Landroid/graphics/drawable/Drawable;
+    invoke-virtual {p0, p1, v3, v2, p2}, Landroid/content/res/Resources;->createFromResourceStream(Landroid/util/TypedValue;Ljava/io/InputStream;Ljava/lang/String;I)Landroid/graphics/drawable/Drawable;

     move-result-object v0

@@ -5604,6 +5624,10 @@

     iput-object v8, v0, Landroid/content/res/TypedArray;->mXml:Landroid/content/res/XmlBlock$Parser;

+    invoke-virtual {p0, v0}, Landroid/content/res/Resources;->loadOverlayTypedArray(Landroid/content/res/TypedArray;)Landroid/content/res/TypedArray;
+
+    move-result-object v0
+
     return-object v0
 .end method

@@ -5686,7 +5710,11 @@

     aput v4, v2, v4

-    return-object v0
+    invoke-virtual {p0, v0}, Landroid/content/res/Resources;->loadOverlayTypedArray(Landroid/content/res/TypedArray;)Landroid/content/res/TypedArray;
+
+    move-result-object v2
+
+    return-object v2
 .end method

 .method public openRawResource(I)Ljava/io/InputStream;

--- a/framework/smali/android/content/res/TypedArray.smali
+++ b/framework/smali/android/content/res/TypedArray.smali
@@ -280,7 +280,7 @@

     .end local v1    # "fullLen":I
     :cond_1
-    new-instance v2, Landroid/content/res/TypedArray;
+    new-instance v2, Landroid/content/res/MiuiTypedArray;

     mul-int/lit8 v3, p1, 0x6

@@ -293,7 +293,7 @@

     new-array v4, v4, [I

-    invoke-direct {v2, p0, v3, v4, p1}, Landroid/content/res/TypedArray;-><init>(Landroid/content/res/Resources;[I[II)V
+    invoke-direct {v2, p0, v3, v4, p1}, Landroid/content/res/MiuiTypedArray;-><init>(Landroid/content/res/Resources;[I[II)V

     return-object v2
 .end method

--- a/framework/smali/android/graphics/Bitmap.smali
+++ b/framework/smali/android/graphics/Bitmap.smali
@@ -59,7 +59,7 @@

 .field private mNinePatchInsets:Landroid/graphics/NinePatch$InsetStruct;

-.field private mRecycled:Z
+.field public mRecycled:Z

 .field private mRequestPremultiplied:Z

-- 
2.9.0

